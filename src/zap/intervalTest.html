<!DOCTYPE html>
<html>
<head>
    <style type="text/css">
        body{font-size:10px;}
        .result{float:left; margin-right:20px;}
    </style>
</head>
<body>

<input id="interval" type="button" value="setInterval" />
<input id="intervalLoop" type="button" value="setInterval w/ loop" />
<input id="timeout" type="button" value="setTimeout" />
<input id="timeoutLoop" type="button" value="setTimeout w/ loop" />
<input id="postMessage" type="button" value="postMessage" />
<input id="postMessageLoop" type="button" value="postMessage w/ loop" />

<div id="output">
    
</div>

<script type="text/javascript">
var intervalCounter = 0, timeoutCounter = 0, iterations = 10000,
    intervalTimes = [], timeoutTimes = [],
    lastIntervalTime = 0, lastTimeoutTime = 0,
    output = document.getElementById("output");

// quick cross-browser events to test speeds on IE
var events = {
    on: (function(){
        if (typeof window.addEventListener === 'function') {
            return function (el, type, fn) {
                el.addEventListener(type, fn, false);
            };
           
        } else if (typeof document.attachEvent === 'function') { // IE
            return function (el, type, fn) {
                el.attachEvent('on' + type, fn);
            };
        }
    })()
    ,remove: (function(){
        if (typeof window.addEventListener === 'function') {   
            return function (el, type, fn) {
                el.removeEventListener(type, fn, false);
            };
        } else {  
            return function (el, type, fn) {
                el.detachEvent('on' + type, fn);
            };
        }
    })()
}


document.getElementById("interval").addEventListener("click", function(e){

    lastIntervalTime = +new Date();
	intervalTimes.length = 0;
    
    var ref = setInterval(function(){
        var d = +new Date(),
            delta = d - lastIntervalTime;
        
        intervalTimes.push(delta);
        
        if(intervalTimes.length >= iterations){
            clearInterval(ref);            
            makeOutput(intervalTimes, 'Interval Test');
        }
        
        lastIntervalTime = d;
    }, 1);

}, false);

document.getElementById("intervalLoop").addEventListener("click", function(e){

    lastIntervalTime = +new Date();
	intervalTimes.length = 0;
    
    var ref = setInterval(function(){
        var d = +new Date(),
            delta = d - lastIntervalTime,
			i = 1000000;
        
        intervalTimes.push(delta);
        
		while(i > 0){ i -= 1; }

        if(intervalTimes.length >= iterations){
            clearInterval(ref);            
            makeOutput(intervalTimes, 'Interval w/ Loop Test');
        }
        
        lastIntervalTime = d;
    }, 1);

}, false);

document.getElementById("timeout").addEventListener("click", function(e){

    lastTimeoutTime = +new Date();
	timeoutTimes.length = 0;

    function run(){
        var d = +new Date(),
            delta = d - lastTimeoutTime;
        
        timeoutTimes.push(delta);
        
        if(timeoutTimes.length >= iterations){
            clearTimeout(ref);            
            makeOutput(timeoutTimes, 'Timeout Test');
        } else {
            setTimeout(run, 1);
        }
        
        lastTimeoutTime = d;
    }

    var ref = setTimeout(run, 1);

}, false);

document.getElementById("timeoutLoop").addEventListener("click", function(e){

    lastTimeoutTime = +new Date();
	timeoutTimes.length = 0;

    function run(){
        var d = +new Date(),
            delta = d - lastTimeoutTime,
			i = 1000000;
        
        timeoutTimes.push(delta);
        
		while(i > 0){ i -= 1; }

        if(timeoutTimes.length >= iterations){
            clearTimeout(ref);            
            makeOutput(timeoutTimes, 'Timeout w/ Loop Test');
        } else {
            setTimeout(run, 1);
        }
        
        lastTimeoutTime = d;
    }

    var ref = setTimeout(run, 1);

}, false);

document.getElementById("postMessage").addEventListener("click", function(e){

	var lastPostMessageTime = +new Date()
		,postMessageTimes = [];
	
    events.remove(window, 'message', run, false);
	events.on(window, 'message', run, false);	

    function run(){
        var d = +new Date(),
            delta = d - lastPostMessageTime;
        
        postMessageTimes.push(delta);

        if(postMessageTimes.length >= iterations){          
            makeOutput(postMessageTimes, 'Post Message Test');
			events.remove(window, 'message', run, false);
        } else {
            window.postMessage('test message', '*');
        }
        
        lastPostMessageTime = d;
    }

	window.postMessage('test message', '*');

}, false);

document.getElementById("postMessageLoop").addEventListener("click", function(e){

	var lastPostMessageTime = +new Date()
		,postMessageTimes = [];
	
	events.remove(window, 'message', run, false);
	events.on(window, 'message', run, false);	

    function run(){
        var d = +new Date(),
            delta = d - lastPostMessageTime,
			i = 1000000;
        
        postMessageTimes.push(delta);
        
		while(i > 0){ i -= 1; }

        if(postMessageTimes.length >= iterations){          
            makeOutput(postMessageTimes, 'Post Message /w Loop Test');
			events.remove(window, 'message', run, false);
        } else {
            window.postMessage('test message', '*');
        }
        
        lastPostMessageTime = d;
    }

	window.postMessage('test message', '*');

}, false);

function makeOutput(resultsArr, heading){
    var avg = 0;
    resultsArr.forEach(function(val){
        avg += val;
    });
    
	avg = (avg / resultsArr.length);

    output.innerHTML +=
        '<div class="result">'
        + '<h1>' + heading + '</h1>'
        + '<p>AVG: ' + avg + '</p>'
		+ '<p>FPS: ' + (1000 / avg) + '</p>'
        + resultsArr.join('<br />')
        + '</div>';
}

</script>    
</body>
</html>