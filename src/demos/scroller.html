<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>ZAP - Scrolling Demo</title>
	</head>
	<body>
		<canvas id="cvsWorld" width="600" height="600" style="background-color: black;"></canvas>
		<div id="info"></div>
		<img src="images/tiny_samus.png" />
		<script type="text/javascript" src="../lib/glMatrix.js"></script>
		<script type="text/javascript" src="../lib/jquery-1.4.2.min.js"></script>
		
		<script src="../zap/Thwap.Core.js" type="text/javascript" charset="utf-8"></script>
		<script src="../zap/Thwap.Entities.js" type="text/javascript" charset="utf-8"></script>
		<script src="../zap/Key.js" type="text/javascript" charset="utf-8"></script>
		<script src="../zap/ZAP.js" type="text/javascript" charset="utf-8"></script>
		<script src="../zap/Entities.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
var CanvasHero = function(){
	
	this.physicsObject = new THWAP.Entities.CircleBox(40);
	this.spriteObject = new ZAP.Entities.Sprite();
	this.spriteObject.setAnimations(
	[
		 'stand_right'
		,'stand_left'
		,'run_right'
		,'run_left'
	],
	[
		[	// stand_right
			 { x: 4  , y: 7, w: 13, h: 22, d: 1000}
		]
		,[	// stand_left
			 { x: 3  , y: 34, w: 13, h: 22, d: 1000}
		]
	//	,[	// run_right
	//		 { x: 3  , y: 4, w: 62, h: 64, d: 1000}
	//		,{ x: 70 , y: 4, w: 62, h: 64, d: 1000}
	//		,{ x: 137, y: 4, w: 62, h: 64, d: 1000}
	//	]
	//	,[	// run_left
	//		 { x: 3  , y: 4, w: 62, h: 64, d: 1000}
	//		,{ x: 70 , y: 4, w: 62, h: 64, d: 1000}
	//		,{ x: 137, y: 4, w: 62, h: 64, d: 1000}
	//	]
	]);

	this.sheet = new Image();
	this.sheet.src = 'images/tiny_samus.png';
	
	this.physicsObject.computeBoundingSphere();
	
	var dangly = new THWAP.Vertex( vec3.add(this.physicsObject.boundingPos, [0,40/2,0], vec3.create()) );
	dangly.isCollidable = false;
	dangly.imass = 1/5;
	this.physicsObject.vlist.push( dangly );
	this.physicsObject.createConstraints(5);
	//var leash1 = new THWAP.LinearConstraint(this.physicsObject.vlist[3], dangly, 5);
	//var leash2 = new THWAP.LinearConstraint(this.physicsObject.vlist[2], dangly, 5);
	//leash1.collidable = false;
	//leash2.collidable = false;
	//this.physicsObject.clist.push(leash1, leash2);
	
	this.physicsObject.clist.forEach(function(c){
		c.collidable = false;
	});
}
CanvasHero.prototype.draw = function(ctx, offset){
	var  x = this.physicsObject.boundingPos[0]
		,y = this.physicsObject.boundingPos[1]
		,curAnimSeq = this.spriteObject.am[
			this.spriteObject.al.indexOf(this.spriteObject.current)]
		,curAFrame = curAnimSeq[ this.spriteObject.aframe ]
		,destX = x+offset[0] - (curAFrame.w/2)
		,destY = y+offset[1] - (curAFrame.h/2);
	
	// TODO: optimize these vars to not recompute
	
	ctx.save();
	ctx.translate(x+offset[0], y+offset[1]);
	ctx.rotate(this.physicsObject.rotation);
	ctx.drawImage(this.sheet, 
		curAFrame.x, curAFrame.y, 
		curAFrame.w, curAFrame.h,
		0 - (curAFrame.w/2), 0 - (curAFrame.h/2),
		curAFrame.w, curAFrame.h);
	ctx.restore();
}
CanvasHero.prototype.update = function(dt, ctx, offset){
	this.spriteObject
		.updateAnimation(dt)
		.setOrientationMatrix
			(this.physicsObject.orientation);
	this.draw(ctx, offset);
}

		
var  TWorld = new THWAP.World()
	,$cWorld = $("#cvsWorld")
	,info = $("#info")[0]
	,ctx = $cWorld[0].getContext('2d')
	,hero = new CanvasHero()
	,focus = hero.physicsObject
	//,focus = new THWAP.Entities.SingleVertexBody(50)
	//,focus = new THWAP.Entities.CircleBox(20)
	//,focus = new THWAP.Entities.ComplexRectangleBody(20,20)
	//,focus = new THWAP.Entities.SolidSphere(50)
	//,focus = new THWAP.Entities.RectangleBody(15,15)
	,bounds = new THWAP.Entities.BoundsBox([-2000,-200,0], [5500,600,0])
	,ground = new THWAP.Entities.RectangleBody(5000, 200);

console.log(focus);

ground.moveTo([-200,500,0]);
ground.vlist.forEach(function(v){
	v.isFree = false;
	//v.isCollidable = false;
});
ground.clist.forEach(function(c){
	c.isFree = false;
});

focus.vlist.forEach(function(v){
	//v.rad = 20;
});

//focus.vlist[2].imass = 1/10;
//focus.vlist[3].imass = 1/10;

focus
	.setPassiveFriction(0.01)
	.setCollisionFriction(0.01);

TWorld
	.addBody(ground)
	.addBody(focus)
	.addBody(bounds);

KEY.listen(function(down){
	if(down[27].delta > 0){ ZAP.CGLM.stop(); }
	
	if(down[87].delta > 0 && down[87].delta < 100){ // W
		focus.addAcceleration([0,-10000,0]);
	}
	
	if(down[83].delta > 0){ // S
		focus.addAcceleration([0,1000,0]);
	}
	
	if(down[65].delta > 0){ // A
		focus.addAcceleration([-1000,0,0]);
	}
	
	if(down[68].delta > 0){ // D
		focus.addAcceleration([1000,0,0]);
	}
});

ZAP.CGLM
	.setFPS(100)
	.setMode('accuracy', 5);

ZAP.CGLM.register(function priorityOne(dt){
	KEY.dispatcher();
	focus.addAcceleration([0,1000,0]);
	TWorld.step(dt*0.001); // dt comes in ms, Thwap needs seconds
}, function priorityTwo(dt, fps, afps, lag, iterations){
	ctx.clearRect(0,0,600,600);
	var offset = ZAP.Scroller.getOffset(focus.boundingPos);
	for(var i = 0; i < TWorld.blist.length; i++){
		TWorld.blist[i].debugDraw(ctx, offset);
	}
	hero.update(dt, ctx, offset);
	//console.log(offset, focus.boundingPos);
	info.innerHTML = "DT: " + dt + " FPS: " + fps + ", AVG FPS: " + afps + " LAG: " + lag + " ITERATIONS: " + iterations;
});

ZAP.Scroller.set([600, 600, 0]);

ZAP.CGLM.start();
		
		</script>
	</body>
</html>